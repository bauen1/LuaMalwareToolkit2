#!/usr/bin/env lua
local args = table.pack(...)

if args.n < 2 then
  io.write([[
Usage:
  ./pack.lua <input file> {<input file>} <output file>
]])
  os.exit(1)
end

local files = {}
local out = assert(io.open(table.remove(args, args.n), "w"))
args.n = args.n - 1

for i = 1, args.n do
  if args[i] == out then
    error("input file can't match output file!")
  else
    local f = assert(io.open(args[i], "r"))
    table.insert(files, f)
  end
end

local data = {}

for k,v in pairs(files) do
  table.insert(data, tostring(v:read("a")))
  v:close()
end

out:write(table.concat(data, ""))
print(string.format("Wrote %i bytes", out:seek("end")))
out:close()
