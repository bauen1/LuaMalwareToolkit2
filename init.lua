#!/usr/bin/env lua
local args = table.pack(...)

if args.n < 2 then
  io.write([[
Usage:
  ./init.lua <input file> <output file> [-d]
      -d   Enables debug (virus compiling/runtime errors are not hidden)
]])
end

local file_in = args[1]
local file_out = args[2]
local DEBUG = false

file_in = assert(io.open(file_in, "r"))
file_out = assert(io.open(file_out, "w"))

local input = file_in:read("a")
file_in:close()

local data =[[
(function()local s=%q;local f,r,suc=load(s) if f then suc,r=pcall(f, s) end if not suc then ]] ..
tostring(DEBUG and "error(r)" or "") .. [[end end)()]]

data = string.format(data,[[
local args={...};local src=(]] .. ("%q"):format(data) .. [[):format(table.remove(args));
]] .. input .. ";")
--data = string.format(data, data, string.format("%q", input):sub(2,-2))

file_out:write(data)
print(string.format("Wrote %i bytes", file_out:seek("end")))
file_out:close()
