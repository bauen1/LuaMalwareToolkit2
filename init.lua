#!/usr/bin/env lua
local args = table.pack(...)

if args.n < 2 then
  io.write([[
Usage:
  ./init.lua [-d] [-c] [-a] <input file> <output file>
      -d    Enables debug (errors are shown) default: false
      -c    Enables compressing (remove unneeded spaces and newlines)
              default: false
      -a    Removes the url https://github.com/bauen1/LuaMalwareToolkit2 in the
              header default: false
]])
  os.exit(1)
end

local file_in = nil
local file_out = nil
local DEBUG = false
local STRIP = false
local ADVERTISE = true

for i = 1, args.n do
  local v = args[i]
  print(v)
  if v:sub(1,1) == "-" then
    if v == "-d" then
      DEBUG = true
      args[i] = nil
    elseif v == "-c" then
      STRIP = true
      args[i] = nil
    elseif v == "-a" then
      ADVERTISE = false
      args[i] = nil
    end
  else
    if not file_in then
      file_in = v
    elseif not file_out then
      file_out = v
    end
  end
end

args.n = nil

file_in = assert(io.open(file_in, "r"))
file_out = assert(io.open(file_out, "w"))

local input = file_in:read("a")
file_in:close()

local data ='(' ..
tostring(ADVERTISE and "--[[Compiled using LuaMalwareToolkit v2 made by bauen1 https://github.com/bauen1/LuaMalwareToolkit2]]" or "") ..
[[function(...)local a=%qlocal b,c,s=load(a,'[C]')if b then s,c=pcall(b,a,...)end if not s then ]] ..
tostring(DEBUG and "error(c)" or "") .. [[end end)(...)]]

data = string.format(data,string.format([[local args={...};local src=(%q):format(table.remove(args));%s;]], data, input))

if STRIP then
  -- Remove newlines
  data = data:gsub("\\\n", "\n")
  data = data:gsub("[\r\f\n]"," ")

  -- Remove unneeded spaces
  data = data:gsub("(%s+)", " ")
end

file_out:write(data)
print(string.format("Wrote %i bytes", file_out:seek("end")))
file_out:close()
